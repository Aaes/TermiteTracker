%!TEX root = Report.tex

\section{Camera and Plotter Integration}
The second part of the project interacting with our tracking device and conform the tracking code to work with the device. We received a Hewlett-Packard 7046a XY-plotter by mail from our councillor at Harvard. Additionally we received a small ant farm, containing one queen and seven worker ants (no soldier ants), via mail and we bought some brushes and acryllic paint for the ants. The ants did not proliferate during the project. While we discussed using infrared paint or fluorescend paint, both these ideas were discarded because both types of paint contains compounds that the termites and ants really like which makes them eat the painted ant. Along with the plotter we also received a small circuit board that plugged into the serial port of the plotter and had a USB cabel for us to communicate with it. Lastly the package contained a collection of petri dishes for us to use. \\

In Section \ref{tracking}, we introduced the theory behind tracking of objects in images. In this section, we describe how the PC, plotter and cameras cooperate, how we get our hands on a frame to process and how we use the techniques from Section \ref{tracking} to turn an ordinary camera into a tracking device.

\subsection{Setup}

The system as a whole contains 4 components

\begin{itemize}
  \item Hewlett Packard 7046A X-Y Recorder (An XY Plotter)
  \item Printed Circuit Board (PCB)
  \item A Gigaware Web Camera 640x480 pixels (overhead camera)
  \item Web Camera 640x480 pixels (mobile camera)
\end{itemize}

\subsubsection{Plotter}
The plotter is a 45x45 table with a mechanical control panel on the side (see fig. XX). The plotter has a movable arm, moving along the X axis, consisting of a 30x3 cm of metal stretching all the way across the table. On this, a piece of plastic is attached, able to move up and down the arm along the Y axis. Together, these units cover the entire area of the plotter table. \\

The control panel is divided into labeled regions with sets of controls to manipulate specific parts of the plotter. Specifically, there is a region with controls for adjusting the zero point of the X-axis, one for the Y-axis, one for power supply etc. Most important of these is the two buttons that is used to adjust the zero point (0,0), as the software produced in this project will send only positive X and Y coordinates. Thus, the zero point must be located outside the area of the arena in order for the plotter arm to reach any possible location of the ant. \\

In order to connect the plotter to a PC, it provides an old-fashioned LPT parallel port interface. In this project, we use a printed circuit board (PCB) converting between LPT and USB. The board has a diode that will light up when signals arrive at the USB side of the board. The diode will give a constant blue light in case of an error, but will otherwise flash green. Together with a PC and an RS232 terminal like e.g. Termite from CompuPhase, this diode is useful for troubleshooting in case something is not working when running the TERMES software. 

%In order to establish a connection to the plotter for debugging purposes, use the connection parameters listed in table \ref{table:connparam}
%
%\begin{table}[h]
%\centering
%\renewcommand{\arraystretch}{1.1}
%\setlength{\tabcolsep}{8pt}
%	\begin{tabular}{ |l|l| }
% 	\hline
%  	\multicolumn{2}{|c|}{Connection Parameters} \\
% 	\hline
%  	Baud Rate & 38400 bps \\
%  	Data Bits & 8 \\
% 	Stop Bits & 1 \\
%  	Parity & none \\
% 	Flow Control & none \\
%  	\hline
%	\end{tabular}
%	\caption{Connection Parameters}
%	\label{table:connparam}
%\end{table}

\subsubsection{Cameras}
To track the ants present in the petri dish, the plotter is equipped with two low resolution standard web cameras connected directly to the PC through USB. One of the cameras are strapped on a piece of hard plastic holding the lens face-down, thus monitoring most of the plotter table from a height of approximately 30 cm. This camera is referred to as the overhead camera and is supposed to provide the user with the big overview, as well as a canvas to draw statistical overlays on, like heatmaps etc. The second camera is mounted directly on the plotter arm and follows the ant as it moves around in the arena. We will refer to this camera as the mobile camera. \\

Both cameras have a resolution of 640x480 pixels (less than 1 megapixel) as opposed to modern digital cameras with a resolution of more than 15 megapixels. Choosing relatively low resolution cameras has been a deliberate decision, as processing is done on a per-frame basis, meaning there is good reason to believe that a higher pixel density would increase processing time and thus prevent the camera from keeping up with the ant. On the other hand, the resolution should be high enough for the software to be able to identify the ant and/or the painted marker on its body. Fortunately, tests have shown that the mobile camera used in this project has been close to optimal with regards to image quality. \\

Another performance indicator for the mobile camera is the amount of frames it is able to record per second (FPS). To be able to maintain a stable tracking process, it is a key property that the ant is present in any two consecutive frames recorded by the camera. If this property is not held, it means that the ant is ahead of the camera, and the plotter will need to initiate a special procedure to relocate the ant. The camera needs at least as many FPS as needed for this to hold. On the other hand, more frames means more processing, which is also not good, but as long as the image quality is modestly low, this should not be a problem. Special techniques have been used to improve processing time, which we will discuss in Section XX. The specific mobile camera that was used in this project has a suitable quality, but could use a higher FPS value. \\

On a side note, it should be noted that the plotter is not new; the internal mechanics are sensitive and will some times cause the arm to do a fast wiggle. The effect of this is similar to taking a picture of a moving object with a DSLR camera whose shutter time is too large. The frame will be blurred and the pixels will "drag lines" that may introduce blobs similar to the one representing the ant. Thus, the plotter is in danger of being biased in a wrong direction and loose track of the ant. This problem is also likely to be reduced by using a camera with a larger FPS rate - or a newer plotter. \\

\subsection{Communication with Plotter}
In order to manipulate the plotter, a high level C++ API was developed, offering instructions like "Go to coordinate (x, y)", "move 10 units to the left", where left is defined in terms of the camera view, etc. Since the coordinate system axes of the plotter and the mobile camera grows in different directions, such an API is very convenient to have in order to construct the logic that moves the camera when the ant leaves the center of the frame. \\

In order to implement this API, we needed to know the hardware protocol of the plotter. This was, however only given informally. Basically, the plotter accepts commands in the pattern given in Equation \ref{eq:plotterformat}.

\begin{center}
  \begin{equation}
  \label{eq:plotterformat}
    0x01 +  xxxx +  yyyy
  \end{equation}
\end{center}

In this format, \textit{xxxx} and \textit{yyyy} are two 4-digit hexadecimal numbers representing the X and Y part of the target coordinate. 0x01 indicates that we are sending something. Thus the plotter can receive coordinates between (0x0, 0x0) and (0xFFFF, 0xFFFF), however, any coordinate larger than (COORDINATES MISSING) lies outside the table area and will overflow and come back at zero. \\

To transmit the coordinates through the USB connection, we use a light weight open source C library (INSERT REFERENCE). This library is implemented directly on top of the operating system specific calls for manipulating I/O resources (\texttt{WriteFile()} in Windows and \texttt{write()} in Unix), thus treating the plotter like it was manipulating a file descriptor. The library contains procedures for opening and closing the connection as well as transferring data. When sending commands in the format of Equation \ref{eq:plotterformat}, one should note that both the X and the Y part needs to be split in two parts of two hex-numbers each. Thus, the data passed to the library should be a 5-entry array of unsigned chars where the 0x01 part goes into the first entry. \\

Using this library, we developed a high level plotter interface that takes coordinates in decimal format and converts them to appropriate arrays that are sent over the connection. Furthermore, we added functions for moving the camera relatively to its own position by remembering the last requested coordinate.

%Hvilken plotter er det og hvilket udstyr sidder på den
%Hvordan er den sat til computeren
%hvad vil vi gerne have den til (nævn at det ville have været nice at have det cross platform)
%hvordan gør vi dette
%hvilke "services" ender vi med at udstille til resten af programmet (flyt til koordinat, current coordinate?)
%Hvordan er performance? kan videoen køre i real time? hvis nej hvad betyder det for os? skal vi skippe frames?

%*   0x01 = send coordinate to plotter
% *   0x01 + 2 bytes for x + 2 bytes for y (up to 10 bits) up to 0x03FF (y probably only up to 01F0)
% *   0x02 in response = sucesss
% *   0xFE in response = failure
 
\subsection{Moving the camera}
Now that we know how to move the plotter, how do we move the camera when the ant moves?
what about the volume of the movement sound?
what about the speed of the movement?
